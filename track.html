<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order - Sanne's Palace</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles/navigation.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="scripts/navigation.js"></script>
    <link rel="icon" type="image/jpeg" href="head.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            padding-top: 80px; /* Height of the navbar */
            padding-bottom: 70px; /* Height of the mobile bottom nav */
            background-color: #f4f4f4;
            min-height: 100vh;
            position: relative;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 80px; /* Fixed height for navbar */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            height: 60px; /* Fixed height for mobile nav */
        }

        .tracking-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .order-header {
            padding: 20px;
            border-bottom: 2px solid #FFD700;
            display: block;
        }

        .order-header h2 {
            margin: 0;
            margin-bottom: 15px;
            color: #000;
        }

        .order-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .status-confirmed {
            background: #fff3cd;
            color: #856404;
        }

        .status-delivering {
            background: #cce5ff;
            color: #004085;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .map-container {
            height: 400px;
            width: 100%;
            border-radius: 0;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .driver-info {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            display: none;
        }

        .driver-info.active {
            display: block;
        }

        .driver-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .vehicle-info {
            color: #666;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            margin-top: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            background: #f8d7da;
            border-radius: 8px;
            margin: 20px 0;
        }

        .driver-marker {
            width: 35px;
            height: 35px;
            background: #FFD700;
            border: 3px solid #000;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            cursor: pointer;
            position: relative;
        }

        .order-details {
            padding: 15px 20px;
            background: #f8f9fa;
            font-size: 0.95rem;
            color: #666;
            border-bottom: 1px solid #e9ecef;
        }

        .order-details-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .order-details-row:last-child {
            margin-bottom: 0;
        }

        .order-details-label {
            font-weight: 600;
            width: 120px;
            color: #495057;
        }

        .order-details-value {
            color: #212529;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        /* Media queries for responsive design */
        @media (max-width: 768px) {
            body {
                padding-top: 60px;
            }

            .container {
                padding: 15px;
            }

            .tracking-card {
                margin: 10px 0;
            }

            .map-container {
                height: 300px;
            }

            .order-header {
                padding: 15px;
            }

            .driver-info {
                padding: 15px;
            }
        }

       

        /* Ensure content is always visible */
        .content-wrapper {
            position: relative;
            z-index: 1;
            margin-top: 20px;
        }


        /* Chat system styles */


.collection-info i {
    width: 20px;
    text-align: center;
    margin-right: 8px;
}

@media (max-width: 768px) {
    .collection-info {
        padding: 15px !important;
    }
}
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo-container">
                <img src="head.png" alt="Sanne's Palace Logo" class="logo">
                <h2 class="brand-name">Sanne's Palace</h1>
            </div>
            <div class="nav-links">
                <a href="menu.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Menu</span>
                </a>
                <a href="orders.html" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    <span>Orders</span>
                </a>
                <a href="#" class="nav-link active">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Track</span>
                </a>
                <a href="profile.html" class="nav-link">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
                <a href="cart.html" class="nav-link cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
            </div>
            <!-- Mobile Top Cart Icon -->
            <a href="cart.html" class="cart-icon mobile-cart">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count">0</span>
            </a>
        </div>
    </nav>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-bottom-nav">
        <div class="mobile-nav-items">
            <a href="menu.html" class="mobile-nav-item">
                <i class="fas fa-home"></i>
                <span>Menu</span>
            </a>
            <a href="orders.html" class="mobile-nav-item">
                <i class="fas fa-list-alt"></i>
                <span>Orders</span>
            </a>
            <a href="#" class="mobile-nav-item active">
                <i class="fas fa-map-marker-alt"></i>
                <span>Track</span>
            </a>
            <a href="profile.html" class="mobile-nav-item">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading order details...</p>
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>

        <div id="order-tracking" class="tracking-card" style="display: none;">
            <div class="order-header">
                <h2>Order #<span id="order-id">Loading...</span></h2>
                <div id="order-time"></div>
            </div>

            <div class="order-status">
                <div id="status-icon" class="status-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <div>
                    <h3 id="status-text">Loading status...</h3>
                    <p id="status-description"></p>
                </div>
            </div>

            <div class="map-container">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>

            <div id="driver-info" class="driver-info">
                <div class="driver-profile">
                    <div class="driver-details">
                        <div id="driver-name" class="driver-name">Loading driver info...</div>
                        <div id="vehicle-info" class="vehicle-info"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>





<style>
    .chat-container {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 300px;
        max-height: 400px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        z-index: 1000;
        border: 2px solid #FFD700;
        overflow: hidden;
    }
    
    .chat-header {
        background: #000000;
        color: #FFD700;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-header h3 {
        margin: 0;
        font-size: 1rem;
    }
    
    .chat-toggle {
        position: fixed;
        bottom: 90px;
        right: 20px;
        background: #000000;
        color: #FFD700;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 999;
        border: 2px solid #FFD700;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 300px;
    }
    
    .message {
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 12px;
        margin: 2px 0;
        word-wrap: break-word;
    }
    
    .message-sent {
        background: #000000;
        color: #FFD700;
        align-self: flex-end;
    }
    
    .message-received {
        background: #FFD700;
        color: #000000;
        align-self: flex-start;
    }
    
    .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #eee;
        background: white;
    }
    
    .chat-input input {
        flex: 1;
        padding: 8px;
        border: 1px solid #FFD700;
        border-radius: 20px;
        margin-right: 8px;
    }
    
    .chat-input button {
        background: #000000;
        color: #FFD700;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
    }
    
    .chat-input button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 4px;
    }
    
    .chat-status {
        padding: 4px 8px;
        font-size: 0.8rem;
        text-align: center;
        color: #666;
    }






    .chat-toggle {
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: #000000;
    color: #FFD700;
    border: 2px solid #FFD700;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 999;
}

.notification-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #FF0000;
    color: white;
    border-radius: 50%;
    min-width: 18px;
    height: 18px;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    padding: 0 4px;
}

.message-status {
    font-size: 0.65rem;
    color: rgba(255, 215, 0, 0.7);
    margin-top: 2px;
    text-align: right;
}
    </style>
    
    
    <div id="chat-toggle" class="chat-toggle" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
    </div>
    
    


    
<div id="chat-toggle" class="chat-toggle" onclick="toggleChat()">
    <i class="fas fa-comments"></i>
    <span class="notification-badge" id="notification-badge">0</span>
</div>

<div id="chat-container" class="chat-container" style="display: none;">
    <div class="chat-header">
        <h3>Order Chat</h3>
        <button onclick="toggleChat()" style="background: none; border: none; color: #FFD700; cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()" id="send-button">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
    

    <!-- <script>
   // Chat system state
let chatUnsubscribe = null;
let currentOrderId = null;
let currentRole = 'customer'; // Set default role

function createMessageElement(message) {
    const div = document.createElement('div');
    div.className = `message ${message.sender === currentRole ? 'message-sent' : 'message-received'}`;
    
    const text = document.createElement('div');
    text.textContent = message.text;
    text.style.wordBreak = 'break-word';
    div.appendChild(text);
    
    const time = document.createElement('div');
    time.className = 'message-time';
    const timestamp = message.timestamp ? new Date(message.timestamp.toDate()) : new Date();
    time.textContent = timestamp.toLocaleTimeString([], { 
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    div.appendChild(time);
    
    // Add read status for sent messages
    if (message.sender === currentRole) {
        const status = document.createElement('div');
        status.className = 'message-status';
        status.textContent = message.read ? 'âœ“âœ“' : 'âœ“';
        div.appendChild(status);
    }
    
    return div;
}

function toggleChat() {
    const chatContainer = document.getElementById('chat-container');
    const chatToggle = document.getElementById('chat-toggle');
    const isVisible = chatContainer.style.display === 'flex';
    
    chatContainer.style.display = isVisible ? 'none' : 'flex';
    chatToggle.style.display = isVisible ? 'flex' : 'none';
    
    if (!isVisible) {
        const messagesDiv = document.getElementById('chat-messages');
        const inputField = document.getElementById('message-input');
        
        // Mark all unread messages as read
        if (currentOrderId) {
            db.collection('orders').doc(currentOrderId)
                .collection('messages')
                .where('read', '==', false)
                .where('sender', '!=', currentRole)
                .get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });
                    return batch.commit();
                });
        }
        
        // Reset notification count
        updateUnreadCount(0);
        
        // Scroll to bottom and focus input
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        if (inputField) {
            inputField.focus();
        }
    }
}

function updateUnreadCount(count) {
    const badge = document.getElementById('notification-badge');
    if (badge) {
        badge.style.display = count > 0 ? 'flex' : 'none';
        badge.textContent = count;
    }
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    const sendButton = document.getElementById('send-button');
    
    if (!message || !currentOrderId) return;
    
    try {
        sendButton.disabled = true;
        input.disabled = true;
        
        await db.collection('orders').doc(currentOrderId)
            .collection('messages')
            .add({
                text: message,
                sender: currentRole,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });
        
        input.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    } finally {
        sendButton.disabled = false;
        input.disabled = false;
        input.focus();
    }
}

function initializeChat(orderId, role) {
    currentOrderId = orderId;
    currentRole = role;
    let unreadCount = 0;
    
    if (chatUnsubscribe) {
        chatUnsubscribe();
    }
    
    chatUnsubscribe = db.collection('orders').doc(orderId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            const messagesDiv = document.getElementById('chat-messages');
            const chatContainer = document.getElementById('chat-container');
            const isVisible = chatContainer.style.display === 'flex';
            
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const message = change.doc.data();
                    const messageElem = createMessageElement(message);
                    messagesDiv.appendChild(messageElem);
                    
                    // Update unread count if chat is not visible
                    if (!isVisible && message.sender !== currentRole) {
                        unreadCount++;
                        updateUnreadCount(unreadCount);
                    }
                    
                    // Mark message as read if chat is visible
                    if (isVisible && message.sender !== currentRole && !message.read) {
                        change.doc.ref.update({ read: true });
                    }
                    
                    // Scroll to bottom
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            });
        });
    
    // Reset unread count when opening chat
    document.getElementById('chat-toggle').addEventListener('click', () => {
        unreadCount = 0;
        updateUnreadCount(0);
    });
    
    // Listen for order status changes
    db.collection('orders').doc(orderId)
        .onSnapshot(doc => {
            if (doc.exists && doc.data().status === 'delivered') {
                deleteAllMessages(orderId);
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                }
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('chat-toggle').style.display = 'none';
            }
        });
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}




// Listen for order status changes
const orderStatusUnsubscribe = db.collection('orders').doc(orderId)
    .onSnapshot(doc => {
        if (doc.exists && doc.data().status === 'delivered') {
            // Delete all messages
            deleteAllMessages(orderId);
            
            // Clear chat listeners
            if (chatUnsubscribe) {
                chatUnsubscribe();
            }
            
            // Hide chat container and toggle button
            const chatContainer = document.getElementById(`chat-container-${orderId}`);
            const chatToggle = document.getElementById(`chat-toggle`);
            if (chatContainer) chatContainer.style.display = 'none';
            if (chatToggle) chatToggle.style.display = 'none';
            
            // Reset notification badge
            updateNotificationBadge(orderId, 0);
        }
    });


async function deleteAllMessages(orderId) {
    try {
        const messages = await db.collection('orders').doc(orderId)
            .collection('messages').get();

             if (messages.empty) return;
            
        const batch = db.batch();
        messages.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
    } catch (error) {
        console.error('Error deleting messages:', error);
    }
}
   
    
   







    
    
    // Initialize chat when page loads
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId') || sessionStorage.getItem('currentOrderId');
        
        if (orderId) {
            // For customer view
            if (window.location.pathname.includes('track.html')) {
                initializeChat(orderId, 'customer');
            }
            // For driver view
            else if (window.location.pathname.includes('driver.html')) {
                initializeChat(orderId, 'driver');
            }
        }
    });
    </script> -->







    <script>
        // Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDAvwoIEXPpCnPpxaKgaleiUHENNDGKG4Q",
    authDomain: "sannes-palace.firebaseapp.com",
    projectId: "sannes-palace",
    storageBucket: "sannes-palace.firebasestorage.app",
    messagingSenderId: "932501443001",
    appId: "1:932501443001:web:18151ec8db5c9b11332668",
    measurementId: "G-4VX18JYY5V"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Initialize Mapbox
mapboxgl.accessToken = 'pk.eyJ1Ijoic3lsdmVzdGVyMzMiLCJhIjoiY200a2JsdDJyMG02NjJrc2xzMG40b25wOSJ9.6MP3EOP-rPYvNIoe9UUxlA';
const SHOP_LOCATION = [29.4029, -23.8646];
let map = null;
let driverMarker = null;
let shopMarker = null;
let deliveryMarker = null;

// Chat system state
let chatUnsubscribe = null;
let currentOrderId = null;
let currentRole = 'customer';

// Initialize map
// Also update the initMap function to check for order type
function initMap() {
    if (!map && document.getElementById('map') && document.querySelector('.map-container').style.display !== 'none') {
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: SHOP_LOCATION,
            zoom: 12,
            pitch: 45
        });

        map.addControl(new mapboxgl.NavigationControl());
        
        shopMarker = new mapboxgl.Marker({ color: '#FF0000' })
            .setLngLat(SHOP_LOCATION)
            .setPopup(new mapboxgl.Popup().setHTML('<h3>Store Location</h3><p>Pickup Point</p>'))
            .addTo(map);

        return map;
    }
}

// Initialize map on load
document.addEventListener('DOMContentLoaded', initMap);

// Load active order
function updateOrderUI(orderData, orderId) {
    document.getElementById('order-id').textContent = orderId;
    
    // Safely handle the timestamp
    let displayTime = '';
    if (orderData.timestamp) {
        if (orderData.timestamp.toDate) {
            // Handle Firestore Timestamp
            displayTime = new Date(orderData.timestamp.toDate()).toLocaleString();
        } else if (typeof orderData.timestamp === 'string') {
            // Handle string timestamp
            displayTime = new Date(orderData.timestamp).toLocaleString();
        } else if (orderData.timestamp instanceof Date) {
            // Handle Date object
            displayTime = orderData.timestamp.toLocaleString();
        }
    }
    document.getElementById('order-time').textContent = displayTime;

    // Update order status based on orderType
    if (orderData.orderType === 'collection') {
        updateCollectionStatus(orderData.status);
    } else {
        updateDeliveryStatus(orderData.status);
    }
    
    const itemsList = document.createElement('div');
    itemsList.className = 'order-items';
    itemsList.innerHTML = `
        <div class="items-header" style="padding: 20px; background: #f8f9fa; margin-top: 20px;">
            <h3>Order Items</h3>
        </div>
        <div class="items-list" style="padding: 20px;">
            ${orderData.items.map(item => `
                <div class="item" style="margin-bottom: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                    <div class="item-name" style="font-weight: 600;">${item.name} x ${item.quantity}</div>
                    <div class="item-price">R${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('')}
            <div class="order-total" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #FFD700;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Subtotal:</span>
                    <span>R${orderData.subtotal?.toFixed(2) || '0.00'}</span>
                </div>
                ${orderData.orderType === 'delivery' ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Delivery Fee:</span>
                    <span>R${orderData.deliveryFee?.toFixed(2) || '0.00'}</span>
                </div>` : ''}
                <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1em;">
                    <span>Total:</span>
                    <span>R${orderData.total?.toFixed(2) || '0.00'}</span>
                </div>
            </div>
        </div>
    `;

    const existingItems = document.querySelector('.order-items');
    if (existingItems) {
        existingItems.remove();
    }
    const orderTime = document.getElementById('order-time');
    orderTime.parentNode.insertBefore(itemsList, orderTime.nextSibling);
}

// Update loadOrderData to include the correct statuses for collection orders
async function loadOrderData(userId) {
    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('order-tracking').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';

        const ordersQuery = await db.collection('orders')
            .where('userId', '==', userId)
            .where('status', 'in', ['received', 'confirmed', 'delivering', 'ready', 'prepared'])
            .orderBy('timestamp', 'desc')
            .limit(1)
            .get();

        if (!ordersQuery.empty) {
            const orderDoc = ordersQuery.docs[0];
            const orderId = orderDoc.id;
            sessionStorage.setItem('currentOrderId', orderId);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('order-tracking').style.display = 'block';
            
            return { orderDoc, orderId };
        } else {
            document.getElementById('loading').style.display = 'none';
            showNoOrdersMessage();
            return null;
        }
    } catch (error) {
        console.error('Error loading order:', error);
        document.getElementById('loading').style.display = 'none';
        showError('Failed to load order details');
        return null;
    }
}
// Setup order tracking
function setupDriverTracking(orderData) {
    if (!orderData.driverId) return;

    // Show driver info
    document.getElementById('driver-info').classList.add('active');
    document.getElementById('driver-name').textContent = orderData.driverName || 'Driver';
    document.getElementById('vehicle-info').textContent = 
        `Vehicle: ${orderData.driverVehicle || 'Assigned'}`;

    // Setup real-time driver location tracking
    const driverLocationUnsubscribe = db.collection('drivers')
        .doc(orderData.driverId)
        .onSnapshot(driverDoc => {
            if (driverDoc.exists) {
                const driverData = driverDoc.data();
                console.log('Driver data:', driverData); // Debug log
                
                if (driverData.currentLocation) {
                    console.log('Updating driver marker:', driverData.currentLocation); // Debug log
                    updateDriverMarker([
                        driverData.currentLocation.longitude,
                        driverData.currentLocation.latitude
                    ]);
                }
            }
        }, error => {
            console.error('Driver tracking error:', error);
        });

    return driverLocationUnsubscribe;
}

function handleDeliveryOrder(orderData) {
    // Show map for delivery orders
    document.querySelector('.map-container').style.display = 'block';
    
    // Remove collection info if it exists
    const collectionInfo = document.querySelector('.collection-info');
    if (collectionInfo) {
        collectionInfo.remove();
    }

    updateDeliveryStatus(orderData.status);

    if (orderData.status === 'delivering' && orderData.driverId) {
        setupDriverTracking(orderData);
    } else {
        if (driverMarker) {
            driverMarker.remove();
            driverMarker = null;
        }
        document.getElementById('driver-info').classList.remove('active');
    }

    if (orderData.address) {
        updateDeliveryMarker(orderData);
    }
}

function handleCollectionOrder(orderData) {
    // Hide delivery-specific elements
    document.getElementById('driver-info').classList.remove('active');
    document.querySelector('.map-container').style.display = 'none';
    
    // Hide chat elements
    document.getElementById('chat-container').style.display = 'none';
    document.getElementById('chat-toggle').style.display = 'none';
    
    if (driverMarker) {
        driverMarker.remove();
        driverMarker = null;
    }
    if (deliveryMarker) {
        deliveryMarker.remove();
        deliveryMarker = null;
    }

    // Add collection information
    const collectionInfo = `
        <div class="collection-info" style="padding: 20px; background: #f8f9fa; border-top: 1px solid #dee2e6;">
            <h3 style="font-weight: 600; margin-bottom: 15px;">Collection Information</h3>
            
            <div style="margin-bottom: 20px;">
                <h4 style="font-weight: 600; color: #495057; margin-bottom: 8px;">Store Location:</h4>
                <p>Sanne's Palace</p>
                <p>UWC Student Centre</p>
                <p>W. Cape</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="font-weight: 600; color: #495057; margin-bottom: 8px;">Operating Hours:</h4>
                <p>Monday - Sunday: 10:00 AM - 10:00 PM</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="font-weight: 600; color: #495057; margin-bottom: 8px;">Contact Information:</h4>
                <p><i class="fas fa-phone"></i> Phone: <a href="tel:+27677586121" style="color: #000; text-decoration: none;">067 758 6121</a></p>
                <p><i class="fas fa-envelope"></i> Email: <a href="mailto:admin@sanneskota.co.za" style="color: #000; text-decoration: none;">admin@sanneskota.co.za</a></p>
            </div>
            
            <div class="collection-note" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <p style="color: #856404; margin-bottom: 0;">
                    <i class="fas fa-info-circle"></i> 
                    Please note: Your order will be kept for up to 1 hour after it's ready. 
                    Make sure to collect it during this time frame.
                </p>
            </div>
        </div>
    `;

    // Remove existing collection info if present
    const existingInfo = document.querySelector('.collection-info');
    if (existingInfo) {
        existingInfo.remove();
    }

    // Insert collection info after order status
    const orderStatus = document.querySelector('.order-status');
    orderStatus.insertAdjacentHTML('afterend', collectionInfo);

    // Update status display for collection orders
    updateCollectionStatus(orderData.status);
}


// Update setupOrderTracking to handle driver tracking
function setupOrderTracking(orderDoc, orderId) {
    let driverLocationUnsubscribe = null;

    // Hide chat elements initially
    document.getElementById('chat-container').style.display = 'none';
    document.getElementById('chat-toggle').style.display = 'none';

    // Listen for order updates
    const unsubscribe = db.collection('orders')
        .doc(orderId)
        .onSnapshot(async (doc) => {
            if (!doc.exists) {
                showError('Order not found');
                return;
            }

            const orderData = doc.data();
            updateOrderUI(orderData, doc.id);

            // Handle different order types
            if (orderData.orderType === 'collection') {
                handleCollectionOrder(orderData);
                // Ensure chat is hidden for collection orders
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('chat-toggle').style.display = 'none';
            } else {
                handleDeliveryOrder(orderData);
                // Show chat toggle for delivery orders
                document.getElementById('chat-toggle').style.display = 'flex';
                initializeChat(orderId, 'customer');

                // Setup driver tracking if order is being delivered
                if (orderData.status === 'delivering' && orderData.driverId) {
                    if (driverLocationUnsubscribe) {
                        driverLocationUnsubscribe();
                    }
                    driverLocationUnsubscribe = setupDriverTracking(orderData);
                } else {
                    if (driverLocationUnsubscribe) {
                        driverLocationUnsubscribe();
                        driverLocationUnsubscribe = null;
                    }
                }
            }

            // Show tracking card
            document.getElementById('order-tracking').style.display = 'block';
            document.getElementById('loading').style.display = 'none';

            if (orderData.status === 'delivered' || orderData.status === 'collected') {
                sessionStorage.removeItem('currentOrderId');
                if (driverLocationUnsubscribe) {
                    driverLocationUnsubscribe();
                }
                // Hide chat when order is complete
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('chat-toggle').style.display = 'none';
            }
        });

    // Cleanup on page unload
    window.addEventListener('unload', () => {
        unsubscribe();
        if (driverLocationUnsubscribe) {
            driverLocationUnsubscribe();
        }
    });
}


function setupOrderTracking(orderDoc, orderId) {
    let driverLocationUnsubscribe = null;

    // Hide chat elements initially
    document.getElementById('chat-container').style.display = 'none';
    document.getElementById('chat-toggle').style.display = 'none';

    // Listen for order updates
    const unsubscribe = db.collection('orders')
        .doc(orderId)
        .onSnapshot(async (doc) => {
            if (!doc.exists) {
                showError('Order not found');
                return;
            }

            const orderData = doc.data();
            updateOrderUI(orderData, doc.id);

            // Handle different order types
            if (orderData.orderType === 'collection') {
                handleCollectionOrder(orderData);
                // Ensure chat is hidden for collection orders
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('chat-toggle').style.display = 'none';
            } else {
                handleDeliveryOrder(orderData);
                // Show chat toggle for delivery orders
                document.getElementById('chat-toggle').style.display = 'flex';
                initializeChat(orderId, 'customer');

                // Setup driver tracking if order is being delivered
                if (orderData.status === 'delivering' && orderData.driverId) {
                    if (driverLocationUnsubscribe) {
                        driverLocationUnsubscribe();
                    }
                    driverLocationUnsubscribe = setupDriverTracking(orderData);
                } else {
                    if (driverLocationUnsubscribe) {
                        driverLocationUnsubscribe();
                        driverLocationUnsubscribe = null;
                    }
                }
            }

            // Show tracking card
            document.getElementById('order-tracking').style.display = 'block';
            document.getElementById('loading').style.display = 'none';

            if (orderData.status === 'delivered' || orderData.status === 'collected') {
                sessionStorage.removeItem('currentOrderId');
                if (driverLocationUnsubscribe) {
                    driverLocationUnsubscribe();
                }
                // Hide chat when order is complete
                document.getElementById('chat-container').style.display = 'none';
                document.getElementById('chat-toggle').style.display = 'none';
            }
        });

    // Cleanup on page unload
    window.addEventListener('unload', () => {
        unsubscribe();
        if (driverLocationUnsubscribe) {
            driverLocationUnsubscribe();
        }
    });
}






// Update Collection Status
function updateCollectionStatus(status) {
    const statusText = document.getElementById('status-text');
    const statusIcon = document.getElementById('status-icon');
    const statusDescription = document.getElementById('status-description');
    
    switch(status) {
        case 'received':
            statusText.textContent = 'Order Received';
            statusIcon.className = 'status-icon status-confirmed';
            statusIcon.innerHTML = 'ðŸ“';
            statusDescription.textContent = 'Your order has been received and will be prepared shortly';
            break;
        case 'confirmed':
            statusText.textContent = 'Preparing Order';
            statusIcon.className = 'status-icon status-confirmed';
            statusIcon.innerHTML = 'ðŸ‘¨â€ðŸ³';
            statusDescription.textContent = 'Your order is being prepared for collection';
            break;
        case 'ready':
            statusText.textContent = 'Ready for Collection';
            statusIcon.className = 'status-icon status-delivering';
            statusIcon.innerHTML = 'âœ¨';
            statusDescription.textContent = 'Your order is ready for collection at our store';
            break;
        case 'collected':
            statusText.textContent = 'Collected';
            statusIcon.className = 'status-icon status-delivered';
            statusIcon.innerHTML = 'âœ…';
            statusDescription.textContent = 'Your order has been collected successfully';
            break;
        default:
            statusText.textContent = 'Processing';
            statusIcon.className = 'status-icon';
            statusIcon.innerHTML = 'â³';
            statusDescription.textContent = 'Your order is being processed';
    }
}

// Update Delivery Status
function updateDeliveryStatus(status) {
    const statusText = document.getElementById('status-text');
    const statusIcon = document.getElementById('status-icon');
    const statusDescription = document.getElementById('status-description');
    
    switch(status) {
        case 'received':
            statusText.textContent = 'Order Received';
            statusIcon.className = 'status-icon status-confirmed';
            statusIcon.innerHTML = 'ðŸ“';
            statusDescription.textContent = 'Your order has been received';
            break;
        case 'confirmed':
            statusText.textContent = 'Preparing Order';
            statusIcon.className = 'status-icon status-confirmed';
            statusIcon.innerHTML = 'ðŸ‘¨â€ðŸ³';
            statusDescription.textContent = 'Your order is being prepared for delivery';
            break;
        case 'delivering':
            statusText.textContent = 'On The Way';
            statusIcon.className = 'status-icon status-delivering';
            statusIcon.innerHTML = 'ðŸš—';
            statusDescription.textContent = 'Your driver is on the way with your order';
            break;
        case 'delivered':
            statusText.textContent = 'Delivered';
            statusIcon.className = 'status-icon status-delivered';
            statusIcon.innerHTML = 'âœ…';
            statusDescription.textContent = 'Your order has been delivered successfully';
            break;
        default:
            statusText.textContent = 'Processing';
            statusIcon.className = 'status-icon';
            statusIcon.innerHTML = 'â³';
            statusDescription.textContent = 'Your order is being processed';
    }
}



// Authentication state observer
auth.onAuthStateChanged(async (user) => {
    if (user) {
        const orderData = await loadOrderData(user.uid);
        if (orderData) {
            setupOrderTracking(orderData.orderDoc, orderData.orderId);
        }
    } else {
        showLoginRequired();
    }
});

// Error handlers
function showError(message) {
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('error-message').innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #721c24; margin-bottom: 10px;">Error</h3>
            <p>${message}</p>
            <p style="margin-top: 10px;">
                <a href="menu.html" style="color: #721c24; text-decoration: underline;">Return to Menu</a>
            </p>
        </div>
    `;
    document.getElementById('order-tracking').style.display = 'none';
    document.getElementById('loading').style.display = 'none';
}

function showNoOrdersMessage() {
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('error-message').innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #721c24; margin-bottom: 10px;">No Active Orders</h3>
            <p>You don't have any orders to track at the moment.</p>
            <p style="margin-top: 10px;">
                <a href="menu.html" style="color: #721c24; text-decoration: underline;">Place an Order</a>
            </p>
        </div>
    `;
    document.getElementById('order-tracking').style.display = 'none';
    document.getElementById('loading').style.display = 'none';
}

function showLoginRequired() {
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('error-message').innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #721c24;margin-bottom: 10px;">Login Required</h3>
            <p>Please log in to track your orders.</p>
            <p style="margin-top: 10px;">
                <a href="login.html" style="color: #721c24; text-decoration: underline;">Login Now</a>
            </p>
        </div>
    `;
    document.getElementById('order-tracking').style.display = 'none';
    document.getElementById('loading').style.display = 'none';
}

// Update map markers
function updateDeliveryMarker(orderData) {
    if (!map || !orderData.address) return;

    if (deliveryMarker) {
        deliveryMarker.remove();
    }

    const addressHtml = `
        <h3>Delivery Location</h3>
        <p>${orderData.address.street}</p>
        <p>${orderData.address.suburb}, ${orderData.address.city}</p>
        <p>${orderData.address.province}, ${orderData.address.postalCode}</p>
        ${orderData.instructions ? `<p><strong>Instructions:</strong> ${orderData.instructions}</p>` : ''}
    `;

    deliveryMarker = new mapboxgl.Marker({ 
        color: orderData.status === 'delivering' ? '#FFA500' : '#000000'
    })
    .setLngLat([orderData.address.coordinates?.longitude || 0, orderData.address.coordinates?.latitude || 0])
    .setPopup(new mapboxgl.Popup().setHTML(addressHtml))
    .addTo(map);

    const bounds = new mapboxgl.LngLatBounds()
        .extend(SHOP_LOCATION)
        .extend([
            orderData.address.coordinates?.longitude || 0,
            orderData.address.coordinates?.latitude || 0
        ]);

    if (driverMarker) {
        bounds.extend(driverMarker.getLngLat());
    }

    map.fitBounds(bounds, { 
        padding: 50,
        maxZoom: 14
    });
}

// Update the updateDriverMarker function
function updateDriverMarker(location) {
    console.log('Updating driver marker with location:', location); // Debug log
    if (!map || !location) return;

    if (driverMarker) {
        driverMarker.remove();
    }

    const el = document.createElement('div');
    el.className = 'driver-marker';
    el.style.width = '35px';
    el.style.height = '35px';
    el.style.backgroundColor = '#FFFFFF';
    el.style.border = '4px solid #FFD700';
    el.style.borderRadius = '50%';
    el.style.boxShadow = '0 0 20px #FFD700';
    el.style.position = 'relative';

    const pulse = document.createElement('div');
    pulse.style.position = 'absolute';
    pulse.style.top = '-5px';
    pulse.style.left = '-5px';
    pulse.style.right = '-5px';
    pulse.style.bottom = '-5px';
    pulse.style.borderRadius = '50%';
    pulse.style.backgroundColor = 'rgba(255, 215, 0, 0.3)';
    pulse.style.animation = 'pulse 1.5s infinite';
    el.appendChild(pulse);

    driverMarker = new mapboxgl.Marker({ element: el })
        .setLngLat(location)
        .setPopup(new mapboxgl.Popup().setHTML('<h3>Driver Location</h3><p>Your order is on the way!</p>'))
        .addTo(map);

    // Center the map to include both shop and driver
    const bounds = new mapboxgl.LngLatBounds()
        .extend(location)
        .extend(SHOP_LOCATION);

    if (deliveryMarker) {
        bounds.extend(deliveryMarker.getLngLat());
    }

    map.fitBounds(bounds, {
        padding: 100,
        duration: 1000
    });
}
// Chat functions
async function initializeChat(orderId, role) {
    currentOrderId = orderId;
    currentRole = role;
    let unreadCount = 0;
    
    if (chatUnsubscribe) {
        chatUnsubscribe();
    }
    
    chatUnsubscribe = db.collection('orders').doc(orderId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            const messagesDiv = document.getElementById('chat-messages');
            const chatContainer = document.getElementById('chat-container');
            const isVisible = chatContainer.style.display === 'flex';
            
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const message = change.doc.data();
                    const messageElem = createMessageElement(message);
                    messagesDiv.appendChild(messageElem);
                    
                    if (!isVisible && message.sender !== currentRole) {
                        unreadCount++;
                        updateUnreadCount(unreadCount);
                    }
                    
                    if (isVisible && message.sender !== currentRole && !message.read) {
                        change.doc.ref.update({ read: true });
                    }
                    
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            });
        });
}

function createMessageElement(message) {
    const div = document.createElement('div');
    div.className = `message ${message.sender === currentRole ? 'message-sent' : 'message-received'}`;
    
    const text = document.createElement('div');
    text.textContent = message.text;
    text.style.wordBreak = 'break-word';
    div.appendChild(text);
    
    const time = document.createElement('div');
    time.className = 'message-time';
    const timestamp = message.timestamp ? new Date(message.timestamp.toDate()) : new Date();
    time.textContent = timestamp.toLocaleTimeString([], { 
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    div.appendChild(time);
    
    if (message.sender === currentRole) {
        const status = document.createElement('div');
        status.className = 'message-status';
        status.textContent = message.read ? 'âœ“âœ“' : 'âœ“';
        div.appendChild(status);
    }
    
    return div;
}

function toggleChat() {
    // Check if this is a collection order
    if (currentOrderId) {
        db.collection('orders').doc(currentOrderId).get().then(doc => {
            if (doc.exists && doc.data().orderType === 'collection') {
                return; // Don't toggle chat for collection orders
            }
            
            const chatContainer = document.getElementById('chat-container');
            const chatToggle = document.getElementById('chat-toggle');
            const isVisible = chatContainer.style.display === 'flex';
            
            chatContainer.style.display = isVisible ? 'none' : 'flex';
            chatToggle.style.display = isVisible ? 'flex' : 'none';
            
            if (!isVisible) {
                const messagesDiv = document.getElementById('chat-messages');
                const inputField = document.getElementById('message-input');
                
                if (currentOrderId) {
                    db.collection('orders').doc(currentOrderId)
                        .collection('messages')
                        .where('read', '==', false)
                        .where('sender', '!=', currentRole)
                        .get()
                        .then(snapshot => {
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                batch.update(doc.ref, { read: true });
                            });
                            return batch.commit();
                        });
                }
                
                updateUnreadCount(0);
                
                if (messagesDiv) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
                if (inputField) {
                    inputField.focus();
                }
            }
        });
    }
}
async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    const sendButton = document.getElementById('send-button');
    
    if (!message || !currentOrderId) return;
    
    try {
        sendButton.disabled = true;
        input.disabled = true;
        
        await db.collection('orders').doc(currentOrderId)
            .collection('messages')
            .add({
                text: message,
                sender: currentRole,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });
        
        input.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    } finally {
        sendButton.disabled = false;
        input.disabled = false;
        input.focus();
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function updateUnreadCount(count) {
    const badge = document.getElementById('notification-badge');
    if (badge) {
        badge.style.display = count > 0 ? 'flex' : 'none';
        badge.textContent = count;
    }
}

// Cleanup function
function cleanup() {
    if (map) {
        map.remove();
        map = null;
    }

    if (driverMarker) {
        driverMarker.remove();
        driverMarker = null;
    }

    if (deliveryMarker) {
        deliveryMarker.remove();
        deliveryMarker = null;
    }

    if (chatUnsubscribe) {
        chatUnsubscribe();
        chatUnsubscribe = null;
    }

    sessionStorage.removeItem('currentOrderId');
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const orderId = params.get('orderId') || sessionStorage.getItem('currentOrderId');
    
    if (orderId) {
        handleSharedOrder(orderId);
    }
});

window.addEventListener('unload', cleanup);

document.addEventListener('visibilitychange', () => {
    if (!document.hidden && auth.currentUser) {
        loadOrderData(auth.currentUser.uid);
    }
});

    </script>

</body>
</html>
